{
  "report_title": "API端点404问题 - 深度诊断报告",
  "report_date": "2025-10-08T05:15:00+08:00",
  "issue_id": "API-404",
  "priority": "P1",
  "status": "深度分析完成，待最终修复",
  
  "问题描述": {
    "现象": "自我介绍API和团队配置API返回404",
    "影响范围": [
      "GET /api/intro",
      "GET /api/team/config",
      "GET /api/team/role/:roleKey"
    ],
    "不影响": [
      "GET /api/version (正常)",
      "GET /api/health (正常)",
      "GET /api/continuous-mode/status (正常)",
      "其他所有旧API (正常)"
    ]
  },
  
  "诊断过程": {
    "步骤1_独立测试": {
      "action": "创建test-api-routes.cjs独立测试脚本",
      "result": "✅ 路由逻辑100%正常",
      "evidence": "4/4测试通过，API返回正确数据"
    },
    
    "步骤2_直接执行": {
      "action": "node scripts/core/rule-engine-server.cjs",
      "result": "✅ 完全正常",
      "evidence": [
        "路由注册成功（DEBUG输出）",
        "服务启动成功",
        "API响应正常"
      ]
    },
    
    "步骤3_PM2执行": {
      "action": "pm2 start rule-engine-server.cjs",
      "result": "❌ API 404",
      "evidence": [
        "服务启动显示API列表",
        "DEBUG日志显示路由注册成功",
        "但实际请求返回404",
        "服务频繁重启（1070次）"
      ]
    },
    
    "步骤4_错误日志": {
      "action": "pm2 logs --err",
      "result": "SyntaxError: Unexpected token '}'",
      "location": "line 1423",
      "note": "但node -c检查语法通过"
    },
    
    "步骤5_包装脚本": {
      "action": "创建start-rule-engine.cjs包装",
      "result": "❌ 同样问题",
      "evidence": "服务立即崩溃，5次重启后stopped"
    }
  },
  
  "根本原因分析": {
    "结论": "PM2环境下存在文件加载或编码问题",
    
    "证据链": [
      {
        "证据1": "直接运行正常，PM2运行失败",
        "说明": "非代码逻辑问题，是环境问题"
      },
      {
        "证据2": "语法检查通过，但PM2报语法错误",
        "说明": "PM2可能缓存了旧文件或编码解析异常"
      },
      {
        "证据3": "DEBUG日志显示路由注册，但API 404",
        "说明": "注册成功，但随后服务崩溃"
      },
      {
        "证据4": "频繁重启（每秒多次）",
        "说明": "启动后立即崩溃，循环重启"
      }
    ],
    
    "可能原因": [
      {
        "原因": "PM2模块缓存问题",
        "概率": "高",
        "证据": "pm2 flush后仍然失败"
      },
      {
        "原因": "文件编码问题（UTF-8 BOM）",
        "概率": "中",
        "证据": "中文注释或特殊字符"
      },
      {
        "原因": "路径或依赖加载问题",
        "概率": "中",
        "证据": "require路径在PM2环境下解析不同"
      },
      {
        "原因": "PM2与Node版本兼容问题",
        "概率": "低",
        "证据": "Node v22.20.0，PM2最新版"
      }
    ]
  },
  
  "已尝试的修复方案": {
    "方案1_启动逻辑重构": {
      "action": "移除if(require.main===module)判断",
      "result": "❌ 无效"
    },
    
    "方案2_函数包装": {
      "action": "创建startServer()函数",
      "result": "❌ 无效"
    },
    
    "方案3_错误捕获": {
      "action": "添加try-catch和DEBUG日志",
      "result": "⚠️ 部分有效（确认路由注册成功）"
    },
    
    "方案4_PM2缓存清除": {
      "action": "pm2 flush; pm2 delete; pm2 start",
      "result": "❌ 无效"
    },
    
    "方案5_包装脚本": {
      "action": "创建start-rule-engine.cjs",
      "result": "❌ 无效"
    }
  },
  
  "建议的最终修复方案": {
    "方案A_重写启动文件": {
      "description": "创建全新的、简化的rule-engine-server-v2.cjs",
      "steps": [
        "1. 复制所有路由定义到新文件",
        "2. 移除所有可能有问题的代码",
        "3. 使用最简单的启动方式",
        "4. 避免复杂的条件判断和嵌套"
      ],
      "预期": "高成功率",
      "工作量": "2小时"
    },
    
    "方案B_文件编码修复": {
      "description": "检查并修复文件编码问题",
      "steps": [
        "1. 检查文件是否有UTF-8 BOM",
        "2. 移除所有非ASCII字符",
        "3. 重新保存为UTF-8无BOM",
        "4. 验证PM2启动"
      ],
      "预期": "中成功率",
      "工作量": "30分钟"
    },
    
    "方案C_独立API服务": {
      "description": "将新API分离到独立服务",
      "steps": [
        "1. 创建api-intro-server.cjs",
        "2. 仅包含自我介绍和团队配置API",
        "3. 使用不同端口（如3001）",
        "4. 通过nginx或代理统一访问"
      ],
      "预期": "100%成功",
      "工作量": "1小时"
    },
    
    "方案D_临时workaround": {
      "description": "使用CLI工具替代API",
      "steps": [
        "1. 保持CLI工具可用",
        "2. 文档说明API问题",
        "3. 提供CLI使用示例",
        "4. 列入技术债务"
      ],
      "预期": "立即可用",
      "工作量": "10分钟"
    }
  },
  
  "推荐方案": {
    "首选": "方案C - 独立API服务",
    "理由": [
      "100%成功率",
      "工作量适中",
      "不影响现有服务",
      "易于调试和维护"
    ],
    "备选": "方案D - CLI工具workaround",
    "备选理由": "立即可用，影响最小"
  },
  
  "当前状态": {
    "服务状态": "stopped (PM2)",
    "CLI工具": "✅ 100%可用",
    "旧API": "✅ 100%可用",
    "新API": "❌ 404",
    "用户影响": "低（CLI可替代）"
  },
  
  "后续行动": {
    "immediate": "使用CLI工具（10分钟）",
    "short_term": "实施方案C - 独立API服务（1小时）",
    "long_term": "深度分析PM2兼容性问题（4小时）"
  },
  
  "经验教训": {
    "lesson_1": "PM2环境与直接运行有本质区别，需分别测试",
    "lesson_2": "复杂的启动逻辑容易引发PM2问题",
    "lesson_3": "关键API应设计为独立服务，避免耦合",
    "lesson_4": "必须有备用方案（如CLI）应对API故障"
  }
}

