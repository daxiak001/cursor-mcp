# 小柳规则引擎系统 - 完整功能手册

**版本：** v6.0+  
**更新时间：** 2025-10-07  
**系统状态：** ✅ 生产就绪

---

## 📋 目录

1. [系统架构图](#系统架构图)
2. [核心功能清单](#核心功能清单)
3. [API接口文档](#api接口文档)
4. [文件结构说明](#文件结构说明)
5. [使用指南](#使用指南)
6. [测试计划](#测试计划)

---

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    小柳规则引擎系统 v6.0                      │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │   规则引擎服务     │
                    │  (Port: 3000)     │
                    │  PM2持久化运行     │
                    └─────────┬─────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
    ┌───▼────┐           ┌───▼────┐           ┌───▼────┐
    │代码检查│           │对话检查│           │质量门禁│
    └───┬────┘           └───┬────┘           └───┬────┘
        │                     │                     │
        │                     │                     │
┌───────┴──────────────────────┴──────────────────┴─────────┐
│                      核心功能模块                           │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ 连续执行模式  │  │ 自动经验记录  │  │  索引注册    │    │
│  │              │  │              │  │              │    │
│  │ • 减少询问    │  │ • 关键词检测  │  │ • 文件索引   │    │
│  │ • 提示词增强  │  │ • 智能标签    │  │ • 模糊搜索   │    │
│  │ • 规则拦截    │  │ • Markdown库 │  │ • 智能推荐   │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                                            │
│  ┌──────────────┐                                         │
│  │  监控系统    │                                          │
│  │              │                                          │
│  │ • API调用记录│                                          │
│  │ • 规则检查    │                                          │
│  │ • Git Hook   │                                          │
│  │ • 数据分析    │                                          │
│  └──────────────┘                                          │
└────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
    ┌───▼────┐           ┌───▼────┐           ┌───▼────┐
    │VSCode  │           │Git Hook│           │CI/CD   │
    │扩展    │           │前置检查│           │质量门禁│
    └────────┘           └────────┘           └────────┘
```

---

## 🎯 核心功能清单

### 1. 规则引擎核心 (rule-engine-server.cjs)

**功能：** 代码和对话质量检查  
**位置：** `scripts/core/rule-engine-server.cjs`  
**端口：** 3000  
**状态：** PM2持久化运行

**主要功能：**
- ✅ 代码质量检查（硬编码、函数长度）
- ✅ 对话行为检查（询问拦截、确认卡检查）
- ✅ 质量门禁（综合检查）
- ✅ 规则热重载

---

### 2. 连续执行辅助模式 (continuous-mode.cjs)

**功能：** 减少AI询问次数，提升执行效率  
**位置：** `scripts/core/continuous-mode.cjs`  
**效果：** 减少60-70%询问

**主要功能：**
- ✅ 启动/停止连续模式
- ✅ 增强提示词注入（1356字符）
- ✅ 询问语句拦截
- ✅ 状态持久化

**API接口：**
```
POST /api/continuous-mode/enable   - 启动
POST /api/continuous-mode/disable  - 停止
GET  /api/continuous-mode/status   - 状态
POST /api/continuous-mode/reset    - 重置
```

---

### 3. 自动经验记录 (experience-logger.cjs)

**功能：** 自动积累错误和成功经验  
**位置：** `scripts/core/experience-logger.cjs`  
**存储：** `.xiaoliu/experience/`

**主要功能：**
- ✅ 自动关键词检测（27个中英文）
- ✅ 智能标签提取
- ✅ Markdown格式存储
- ✅ 经验搜索和统计

**API接口：**
```
POST /api/experience/log     - 手动记录
GET  /api/experience/search  - 搜索经验
GET  /api/experience/stats   - 统计信息
```

**关键词库：**
- 错误：错误、error、bug、失败、异常、问题、报错...
- 成功：成功、success、解决、修复、完成、通过...

---

### 4. 索引注册系统 (index-registry.cjs)

**功能：** 文件索引、快速查找、智能推荐  
**位置：** `scripts/core/index-registry.cjs`  
**存储：** `.xiaoliu/index/`

**主要功能：**
- ✅ 文件索引构建（20ms/252文件）
- ✅ 模糊搜索算法
- ✅ 智能推荐（同目录+同分类+相似名）
- ✅ 决策记录追踪
- ✅ SHA256文件完整性

**API接口：**
```
POST /api/index/build          - 构建索引
GET  /api/index/search         - 搜索文件
POST /api/index/decision       - 记录决策
GET  /api/index/status         - 获取状态
GET  /api/index/file           - 文件详情
GET  /api/index/recommendations - 推荐文件
```

**文件分类：**
- code: .js, .ts, .jsx, .tsx, .cjs, .mjs
- config: .json, .yaml, .yml, .toml, .ini
- docs: .md, .txt, .rst, .adoc
- styles: .css, .scss, .sass, .less
- scripts: .sh, .ps1, .bat, .cmd
- data: .sql, .db, .sqlite, .csv

---

### 5. 监控系统 (monitor-logger.cjs)

**功能：** 记录和分析系统运行数据  
**位置：** `scripts/core/monitor-logger.cjs`  
**存储：** `logs/monitor.log`

**主要功能：**
- ✅ API调用记录
- ✅ 规则检查记录
- ✅ Git Hook执行记录
- ✅ 健康检查记录
- ✅ 错误日志记录

**分析工具：**
```bash
npm run monitor:report     - 生成分析报告
npm run monitor:dashboard  - 显示控制台
npm run monitor:live       - 实时监控
```

---

## 📡 API接口完整列表

### 基础接口

#### 1. 健康检查
```http
GET /api/health

响应：
{
  "status": "healthy",
  "uptime": 3600,
  "timestamp": "2025-10-07T..."
}
```

#### 2. 重载规则
```http
POST /api/reload-rules

响应：
{
  "success": true,
  "message": "规则已重新加载"
}
```

---

### 代码检查接口

#### 3. 代码质量检查
```http
POST /api/check-code
Content-Type: application/json

{
  "code": "const password = '123456';"
}

响应：
{
  "pass": false,
  "violations": [
    {
      "rule": "IR-003",
      "level": "error",
      "message": "检测到硬编码密码"
    }
  ]
}
```

---

### 对话检查接口

#### 4. 对话行为检查
```http
POST /api/check-dialogue
Content-Type: application/json

{
  "message": "是否继续执行？",
  "context": "开发任务"
}

响应：
{
  "pass": false,
  "violations": [
    {
      "rule": "SIL-003",
      "level": "error",
      "message": "不得询问用户"
    }
  ],
  "continuousModeActive": true,
  "enhancedPrompt": "..."
}
```

---

### 质量门禁接口

#### 5. 质量门禁检查
```http
POST /api/quality-gate
Content-Type: application/json

{
  "metrics": {
    "coverage": 85,
    "duplicateRate": 3,
    "testPassRate": 95
  }
}

响应：
{
  "pass": true,
  "gates": [
    {
      "name": "coverage",
      "pass": true,
      "value": 85,
      "threshold": 80
    }
  ]
}
```

---

### 连续执行模式接口 (4个)

#### 6. 启动连续模式
```http
POST /api/continuous-mode/enable
Content-Type: application/json

{
  "taskDescription": "开发用户管理系统"
}

响应：
{
  "success": true,
  "message": "🚀 连续执行辅助模式已启动...",
  "sessionId": "session-xxx",
  "enhancedPrompt": "..."
}
```

#### 7. 停止连续模式
```http
POST /api/continuous-mode/disable

响应：
{
  "success": true,
  "message": "⏸️ 连续执行模式已停止",
  "details": "任务运行时长: 15.3 分钟"
}
```

#### 8. 查看状态
```http
GET /api/continuous-mode/status

响应：
{
  "enabled": true,
  "message": "🚀 连续执行模式运行中",
  "task": "开发用户管理系统",
  "duration": "15.3 分钟"
}
```

#### 9. 重置状态
```http
POST /api/continuous-mode/reset

响应：
{
  "success": true,
  "message": "连续执行模式状态已重置"
}
```

---

### 经验记录接口 (3个)

#### 10. 手动记录经验
```http
POST /api/experience/log
Content-Type: application/json

{
  "type": "error",
  "description": "PM2启动失败：模块类型冲突",
  "solution": "将.js改为.cjs，使用CommonJS模式",
  "context": "规则引擎服务",
  "ruleId": "IR-003"
}

响应：
{
  "success": true,
  "message": "经验已记录"
}
```

#### 11. 搜索经验
```http
GET /api/experience/search?keyword=PM2&type=error

响应：
{
  "success": true,
  "count": 2,
  "results": [
    {
      "type": "error",
      "title": "PM2启动失败：模块类型冲突",
      "time": "2025/10/07 23:21",
      "solution": "将.js改为.cjs...",
      "snippet": "..."
    }
  ]
}
```

#### 12. 获取统计
```http
GET /api/experience/stats

响应：
{
  "success": true,
  "stats": {
    "errorCount": 5,
    "successCount": 8,
    "totalCount": 13,
    "recentErrors": ["..."],
    "recentSuccesses": ["..."]
  }
}
```

---

### 索引注册接口 (6个)

#### 13. 构建索引
```http
POST /api/index/build

响应：
{
  "success": true,
  "count": 252,
  "duration": 20,
  "categories": {
    "code": 38,
    "config": 36,
    "docs": 139
  }
}
```

#### 14. 搜索文件
```http
GET /api/index/search?query=rule-engine&category=code&limit=10

响应：
{
  "success": true,
  "count": 1,
  "query": "rule-engine",
  "category": "code",
  "results": [
    {
      "path": "scripts/core/rule-engine-server.cjs",
      "name": "rule-engine-server.cjs",
      "category": "code",
      "score": 100
    }
  ]
}
```

#### 15. 记录决策
```http
POST /api/index/decision
Content-Type: application/json

{
  "queries": ["如何实现规则引擎"],
  "targetAction": "创建规则引擎服务",
  "targetFiles": ["scripts/core/rule-engine-server.cjs"],
  "reason": "实现代码质量检查"
}

响应：
{
  "success": true,
  "file": "decision.json",
  "timestamp": "decision-2025-10-07..."
}
```

#### 16. 获取状态
```http
GET /api/index/status

响应：
{
  "built": true,
  "builtAt": "2025-10-07T15:29:05.150Z",
  "count": 252,
  "categories": {...}
}
```

#### 17. 文件详情
```http
GET /api/index/file?path=package.json

响应：
{
  "success": true,
  "path": "package.json",
  "category": "config",
  "size": 2290,
  "sha256": "c79abda58..."
}
```

#### 18. 推荐文件
```http
GET /api/index/recommendations?file=scripts/core/rule-engine-server.cjs&limit=5

响应：
{
  "success": true,
  "currentFile": "scripts/core/rule-engine-server.cjs",
  "count": 3,
  "recommendations": [
    {
      "path": "scripts/tests/test-rule-engine.cjs",
      "score": 100
    }
  ]
}
```

---

## 📁 文件结构说明

```
【项目】开发材料/
│
├─ scripts/                          # 脚本目录（已优化）
│   ├─ core/                         # 核心模块（8个）
│   │   ├─ rule-engine-server.cjs   # 规则引擎服务 ⭐
│   │   ├─ continuous-mode.cjs      # 连续执行模式 ⭐
│   │   ├─ experience-logger.cjs    # 经验记录器 ⭐
│   │   ├─ index-registry.cjs       # 索引注册器 ⭐
│   │   ├─ monitor-logger.cjs       # 监控日志 ⭐
│   │   ├─ logger.cjs               # 通用日志
│   │   ├─ dashboard.cjs            # 监控控制台
│   │   └─ analyze-monitor.cjs      # 监控分析
│   │
│   ├─ tests/                        # 测试脚本（7个）
│   │   ├─ test-rule-engine.cjs
│   │   ├─ test-continuous-mode.cjs
│   │   ├─ test-experience-logger.cjs
│   │   ├─ test-index-registry.cjs
│   │   ├─ validate-execution-rate.js
│   │   ├─ diff_test.cjs
│   │   └─ augment_tests.cjs
│   │
│   ├─ ci/                           # CI/CD脚本（8个）
│   │   ├─ simulate-ci.ps1
│   │   ├─ preflight.ps1
│   │   ├─ run_reports.ps1
│   │   ├─ policy_report.ps1
│   │   ├─ contract_check.cjs
│   │   ├─ interface_diff.cjs
│   │   ├─ smoke_analyze.cjs
│   │   └─ generate_domain_smoke_tests.cjs
│   │
│   └─ tools/                        # 工具脚本（25个）
│       ├─ deploy.ps1
│       ├─ hardcode_scan.ps1
│       ├─ live_guard.cjs
│       ├─ pre_dev_guard.cjs
│       └─ ...
│
├─ policy/                           # 规则配置
│   ├─ core-l1.yaml                 # 核心阻断规则
│   ├─ dialogue-l1.yaml             # 对话行为规则
│   ├─ quality-l2.yaml              # 质量规则
│   ├─ security-l3.yaml             # 安全规则
│   ├─ quality-gates.json           # 质量门禁配置
│   └─ ...
│
├─ reports/                          # 报告目录
│   ├─ completed/                   # 完成报告（21个）
│   │   ├─ 系统优化完成报告.md
│   │   ├─ MCP功能迁移总结报告.md
│   │   └─ ...
│   └─ archive/                     # 历史归档
│
├─ logs/                            # 日志目录
│   └─ monitor.log                  # 监控日志
│
├─ .xiaoliu/                        # 数据目录
│   ├─ experience/                  # 经验库
│   │   ├─ 错误经验.md
│   │   └─ 成功经验.md
│   └─ index/                       # 索引库
│       ├─ index.json
│       ├─ files.json
│       ├─ categorized.json
│       └─ decision.json
│
├─ package.json                     # NPM配置
├─ vitest.config.ts                # 测试配置
└─ README.md                        # 项目说明
```

---

## 📖 使用指南

### 1. 启动系统

```bash
# 方式1: 使用PM2（推荐）
npm run rule-engine:start
pm2 save

# 方式2: 直接运行
node scripts/core/rule-engine-server.cjs

# 检查状态
pm2 list
```

### 2. 使用连续执行模式

```bash
# 启动（使用curl）
curl -X POST http://localhost:3000/api/continuous-mode/enable \
  -H "Content-Type: application/json" \
  -d '{"taskDescription":"开发用户管理系统"}'

# 查看状态
curl http://localhost:3000/api/continuous-mode/status

# 停止
curl -X POST http://localhost:3000/api/continuous-mode/disable
```

### 3. 查询经验库

```bash
# 搜索错误经验
curl "http://localhost:3000/api/experience/search?keyword=PM2&type=error"

# 获取统计
curl http://localhost:3000/api/experience/stats
```

### 4. 使用文件索引

```bash
# 首次使用：构建索引
curl -X POST http://localhost:3000/api/index/build

# 搜索文件
curl "http://localhost:3000/api/index/search?query=rule-engine"

# 获取推荐
curl "http://localhost:3000/api/index/recommendations?file=package.json"
```

### 5. 运行测试

```bash
# 测试规则引擎
npm run rule-engine:test

# 测试连续模式
npm run continuous:test

# 测试经验记录
npm run experience:test

# 测试索引注册
npm run index:test

# 运行所有测试
npm test

# CI完整流程
npm run ci:all
```

### 6. 监控系统

```bash
# 生成监控报告
npm run monitor:report

# 查看控制台
npm run monitor:dashboard

# 实时监控
npm run monitor:live
```

---

## 🧪 完整测试计划

### 测试环境准备

```bash
# 1. 确保PM2服务运行
pm2 list
# 应该看到 xiaoliu-rule-engine 状态为 online

# 2. 确保端口可用
curl http://localhost:3000/api/health
# 应该返回 {"status":"healthy"}

# 3. 清空测试数据（可选）
rm -rf .xiaoliu
rm -rf logs/monitor.log
```

---

### 测试用例清单

#### 阶段1: 基础功能测试（10分钟）

**1.1 规则引擎健康检查**
```bash
# 测试目标：验证服务正常运行
# 期望结果：返回healthy状态

curl http://localhost:3000/api/health

# ✅ 通过标准：
# - 返回 200 状态码
# - 包含 "status": "healthy"
```

**1.2 代码质量检查**
```bash
# 测试目标：检测硬编码
# 期望结果：识别出违规

curl -X POST http://localhost:3000/api/check-code \
  -H "Content-Type: application/json" \
  -d '{"code":"const password = \"123456\";"}'

# ✅ 通过标准：
# - pass: false
# - violations 包含 IR-003
```

**1.3 对话行为检查**
```bash
# 测试目标：检测询问语句
# 期望结果：识别出违规

curl -X POST http://localhost:3000/api/check-dialogue \
  -H "Content-Type: application/json" \
  -d '{"message":"是否继续执行？"}'

# ✅ 通过标准：
# - pass: false
# - violations 包含 SIL-003
```

---

#### 阶段2: 连续执行模式测试（15分钟）

**2.1 启动连续模式**
```bash
# 测试目标：成功启动模式
# 期望结果：返回成功消息

curl -X POST http://localhost:3000/api/continuous-mode/enable \
  -H "Content-Type: application/json" \
  -d '{"taskDescription":"测试任务"}'

# ✅ 通过标准：
# - success: true
# - 包含 sessionId
# - 包含 enhancedPrompt
```

**2.2 查看状态**
```bash
# 测试目标：获取运行状态
# 期望结果：显示已启动

curl http://localhost:3000/api/continuous-mode/status

# ✅ 通过标准：
# - enabled: true
# - 显示任务描述
# - 显示运行时长
```

**2.3 模式拦截测试**
```bash
# 测试目标：拦截询问语句
# 期望结果：增加CONTINUOUS-MODE违规

curl -X POST http://localhost:3000/api/check-dialogue \
  -H "Content-Type: application/json" \
  -d '{"message":"要不要继续？"}'

# ✅ 通过标准：
# - violations 包含 CONTINUOUS-MODE
# - continuousModeActive: true
```

**2.4 停止模式**
```bash
# 测试目标：成功停止模式
# 期望结果：返回运行时长

curl -X POST http://localhost:3000/api/continuous-mode/disable

# ✅ 通过标准：
# - success: true
# - 显示运行时长
```

**2.5 运行自动化测试**
```bash
# 测试目标：所有测试通过
# 期望结果：7/7 通过

npm run continuous:test

# ✅ 通过标准：
# - 通过率 100% (7/7)
```

---

#### 阶段3: 经验记录测试（15分钟）

**3.1 手动记录错误经验**
```bash
# 测试目标：成功记录经验
# 期望结果：创建经验文件

curl -X POST http://localhost:3000/api/experience/log \
  -H "Content-Type: application/json" \
  -d '{
    "type": "error",
    "description": "测试错误：连接超时",
    "solution": "增加超时时间到30秒",
    "context": "数据库连接",
    "ruleId": "TEST-001"
  }'

# ✅ 通过标准：
# - success: true
# - 文件 .xiaoliu/experience/错误经验.md 已创建
```

**3.2 手动记录成功经验**
```bash
# 测试目标：成功记录经验
# 期望结果：创建经验文件

curl -X POST http://localhost:3000/api/experience/log \
  -H "Content-Type: application/json" \
  -d '{
    "type": "success",
    "description": "成功实现缓存优化",
    "solution": "使用Redis缓存，性能提升50%",
    "context": "性能优化"
  }'

# ✅ 通过标准：
# - success: true
# - 文件 .xiaoliu/experience/成功经验.md 已更新
```

**3.3 搜索经验**
```bash
# 测试目标：找到相关经验
# 期望结果：返回搜索结果

curl "http://localhost:3000/api/experience/search?keyword=超时&type=error"

# ✅ 通过标准：
# - success: true
# - count >= 1
# - results 包含"测试错误：连接超时"
```

**3.4 获取统计**
```bash
# 测试目标：统计正确
# 期望结果：返回统计数据

curl http://localhost:3000/api/experience/stats

# ✅ 通过标准：
# - errorCount >= 1
# - successCount >= 1
# - totalCount = errorCount + successCount
```

**3.5 自动检测测试**
```bash
# 测试目标：自动记录
# 期望结果：检测到关键词并记录

curl -X POST http://localhost:3000/api/check-dialogue \
  -H "Content-Type: application/json" \
  -d '{"message":"遇到错误：PM2启动失败。解决方案：使用.cjs格式"}'

# 等待1秒后检查
sleep 1
curl "http://localhost:3000/api/experience/search?keyword=PM2"

# ✅ 通过标准：
# - 找到包含"PM2"的经验记录
```

**3.6 运行自动化测试**
```bash
# 测试目标：大部分测试通过
# 期望结果：>85%通过率

npm run experience:test

# ✅ 通过标准：
# - 通过率 >= 85% (7/8或更好)
```

---

#### 阶段4: 索引注册测试（15分钟）

**4.1 构建索引**
```bash
# 测试目标：成功构建索引
# 期望结果：返回文件数量

curl -X POST http://localhost:3000/api/index/build

# ✅ 通过标准：
# - success: true
# - count > 0
# - 包含 categories 统计
# - 文件 .xiaoliu/index/index.json 已创建
```

**4.2 获取状态**
```bash
# 测试目标：索引状态正常
# 期望结果：显示索引信息

curl http://localhost:3000/api/index/status

# ✅ 通过标准：
# - built: true
# - 包含 builtAt 时间戳
# - count 与构建时一致
```

**4.3 搜索文件（全部）**
```bash
# 测试目标：找到匹配文件
# 期望结果：返回搜索结果

curl "http://localhost:3000/api/index/search?query=package&limit=5"

# ✅ 通过标准：
# - success: true
# - count >= 1
# - results 包含 package.json
```

**4.4 搜索文件（分类）**
```bash
# 测试目标：分类搜索正确
# 期望结果：只返回代码文件

curl "http://localhost:3000/api/index/search?query=rule&category=code"

# ✅ 通过标准：
# - 所有结果 category 都是 "code"
# - 找到 rule-engine-server.cjs
```

**4.5 获取文件详情**
```bash
# 测试目标：获取完整信息
# 期望结果：返回详细数据

curl "http://localhost:3000/api/index/file?path=package.json"

# ✅ 通过标准：
# - success: true
# - 包含 size, category, sha256
# - category 应该是 "config"
```

**4.6 智能推荐**
```bash
# 测试目标：推荐相关文件
# 期望结果：返回推荐列表

curl "http://localhost:3000/api/index/recommendations?file=scripts/core/rule-engine-server.cjs&limit=3"

# ✅ 通过标准：
# - success: true
# - count > 0
# - recommendations 包含相关文件
# - score > 0
```

**4.7 记录决策**
```bash
# 测试目标：成功记录决策
# 期望结果：创建决策文件

curl -X POST http://localhost:3000/api/index/decision \
  -H "Content-Type: application/json" \
  -d '{
    "queries": ["如何测试索引系统"],
    "targetAction": "执行索引测试",
    "targetFiles": ["scripts/tests/test-index-registry.cjs"],
    "reason": "验证索引功能"
  }'

# ✅ 通过标准：
# - success: true
# - 文件 .xiaoliu/index/decision.json 已创建
# - 包含时间戳文件
```

**4.8 运行自动化测试**
```bash
# 测试目标：所有测试通过
# 期望结果：8/8 通过

npm run index:test

# ✅ 通过标准：
# - 通过率 100% (8/8)
```

---

#### 阶段5: 监控系统测试（10分钟）

**5.1 检查监控日志**
```bash
# 测试目标：日志已记录
# 期望结果：文件存在且有内容

ls -lh logs/monitor.log

# ✅ 通过标准：
# - 文件存在
# - 大小 > 0
```

**5.2 生成监控报告**
```bash
# 测试目标：生成分析报告
# 期望结果：创建报告文件

npm run monitor:report

# ✅ 通过标准：
# - 创建 reports/monitor-report-*.md
# - 报告包含统计数据
```

**5.3 查看控制台**
```bash
# 测试目标：显示监控数据
# 期望结果：输出统计信息

npm run monitor:dashboard

# ✅ 通过标准：
# - 显示API调用统计
# - 显示规则检查统计
# - 显示系统健康状态
```

---

#### 阶段6: 集成测试（15分钟）

**6.1 完整工作流测试**
```bash
# 测试场景：开发一个功能的完整流程

# 1. 启动连续模式
curl -X POST http://localhost:3000/api/continuous-mode/enable \
  -H "Content-Type: application/json" \
  -d '{"taskDescription":"开发登录功能"}'

# 2. 搜索相关文件
curl "http://localhost:3000/api/index/search?query=auth"

# 3. 获取文件推荐
# （假设找到了 auth.js）
curl "http://localhost:3000/api/index/recommendations?file=src/auth.js"

# 4. 记录开发决策
curl -X POST http://localhost:3000/api/index/decision \
  -H "Content-Type: application/json" \
  -d '{
    "queries": ["如何实现登录"],
    "targetAction": "创建登录API",
    "targetFiles": ["src/auth.js", "src/routes/login.js"]
  }'

# 5. 代码质量检查
curl -X POST http://localhost:3000/api/check-code \
  -H "Content-Type: application/json" \
  -d '{"code":"function login(username, password) { return true; }"}'

# 6. 遇到问题，记录经验
curl -X POST http://localhost:3000/api/experience/log \
  -H "Content-Type: application/json" \
  -d '{
    "type": "error",
    "description": "JWT验证失败",
    "solution": "检查secret配置"
  }'

# 7. 停止连续模式
curl -X POST http://localhost:3000/api/continuous-mode/disable

# ✅ 通过标准：
# - 所有步骤执行成功
# - 数据正确记录
# - 系统状态正常
```

**6.2 并发测试**
```bash
# 测试目标：验证并发处理
# 期望结果：所有请求成功

# 使用 Apache Bench 或手动并发请求
for i in {1..10}; do
  curl http://localhost:3000/api/health &
done
wait

# ✅ 通过标准：
# - 所有请求返回 200
# - 无错误日志
```

**6.3 规则引擎自测**
```bash
# 测试目标：规则引擎测试通过
# 期望结果：所有规则检查正常

npm run rule-engine:test

# ✅ 通过标准：
# - 通过率 100%
```

**6.4 执行率验证**
```bash
# 测试目标：系统执行率达标
# 期望结果：>90%执行率

npm run validate:execution-rate

# ✅ 通过标准：
# - 执行率 >= 90%
# - 生成验证报告
```

**6.5 CI完整流程**
```bash
# 测试目标：CI流程正常
# 期望结果：所有检查通过

npm run ci:all

# ✅ 通过标准：
# - 所有CI步骤成功
# - 无阻断性错误
```

---

### 测试结果记录模板

```markdown
# 系统功能测试报告

**测试日期：** YYYY-MM-DD  
**测试人员：** [姓名]  
**测试环境：** Windows/Mac/Linux

## 测试结果汇总

| 阶段 | 测试用例数 | 通过 | 失败 | 通过率 |
|------|----------|------|------|--------|
| 阶段1: 基础功能 | 3 | ? | ? | ?% |
| 阶段2: 连续执行 | 5 | ? | ? | ?% |
| 阶段3: 经验记录 | 6 | ? | ? | ?% |
| 阶段4: 索引注册 | 8 | ? | ? | ?% |
| 阶段5: 监控系统 | 3 | ? | ? | ?% |
| 阶段6: 集成测试 | 5 | ? | ? | ?% |
| **总计** | **30** | **?** | **?** | **?%** |

## 详细测试记录

### 阶段1: 基础功能测试
- [ ] 1.1 规则引擎健康检查
  - 实际结果：
  - 问题：
  
- [ ] 1.2 代码质量检查
  - 实际结果：
  - 问题：

### 阶段2: 连续执行模式测试
...

## 发现的问题

1. **问题描述**
   - 严重程度：高/中/低
   - 复现步骤：
   - 期望结果：
   - 实际结果：

## 建议和改进

1. ...
2. ...

## 测试结论

- [ ] 系统功能完整
- [ ] 所有核心功能正常
- [ ] 建议投入生产使用
- [ ] 需要修复问题后再测试
```

---

## 📊 功能优先级

### 🔴 核心功能（必须正常）
1. ⭐⭐⭐ 规则引擎服务（基础）
2. ⭐⭐⭐ 代码质量检查
3. ⭐⭐⭐ 对话行为检查

### 🟡 重要功能（推荐使用）
4. ⭐⭐ 连续执行模式
5. ⭐⭐ 经验记录系统
6. ⭐⭐ 索引注册系统

### 🟢 辅助功能（增强体验）
7. ⭐ 监控系统
8. ⭐ 质量门禁
9. ⭐ CI/CD工具

---

## 🚨 常见问题

### Q1: 规则引擎启动失败？
```bash
# 检查端口占用
netstat -ano | findstr :3000

# 重启服务
pm2 restart xiaoliu-rule-engine

# 查看日志
pm2 logs xiaoliu-rule-engine
```

### Q2: API调用返回404？
```bash
# 确认服务运行
curl http://localhost:3000/api/health

# 检查路径是否正确
# 注意：所有API都以 /api/ 开头
```

### Q3: 索引未构建？
```bash
# 首次使用必须构建索引
curl -X POST http://localhost:3000/api/index/build

# 检查索引状态
curl http://localhost:3000/api/index/status
```

### Q4: 经验未记录？
```bash
# 检查关键词是否匹配
# 错误关键词：错误、error、bug、失败...
# 成功关键词：成功、success、解决、修复...

# 手动记录
curl -X POST http://localhost:3000/api/experience/log \
  -H "Content-Type: application/json" \
  -d '{"type":"error","description":"..."}'
```

---

## 📚 相关文档

1. **系统优化完成报告.md** - 优化详情
2. **MCP功能迁移总结报告.md** - 迁移说明
3. **监管系统使用指南.md** - 监控系统
4. **连续执行模式修正报告.md** - 连续模式

所有报告位于：`reports/completed/`

---

**文档版本：** 1.0  
**最后更新：** 2025-10-07  
**维护者：** 小柳团队

