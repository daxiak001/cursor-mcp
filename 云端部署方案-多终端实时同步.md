# 小柳系统云端部署方案 - 多终端实时同步

**方案日期：** 2025-10-08  
**当前版本：** v6.1.1  
**目标架构：** 云端SaaS服务  
**核心能力：** 多终端访问 + 实时升级 + 统一管理

---

## 📊 执行摘要

### 核心目标

✅ **多终端访问** - 任意电脑、任意Cursor窗口都能使用  
✅ **实时升级** - 云端一次升级，所有终端立即生效  
✅ **统一管理** - 规则、配置、监测数据集中管理  
✅ **零安装** - 客户端无需安装，仅需配置API地址  

### 技术可行性

| 维度 | 评分 | 说明 |
|------|------|------|
| **技术可行性** | 95/100 | 现有架构天然支持云端部署 |
| **实施难度** | 70/100 | 中等难度，需要部署和运维 |
| **成本控制** | 85/100 | 可选免费方案或低成本方案 |
| **维护成本** | 90/100 | 云端统一维护，成本降低 |

---

## 🏗️ 第一部分：系统架构设计

---

## 1. 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      ☁️ 云端服务器                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  🎯 小柳规则引擎服务 (Rule Engine API)                  │  │
│  │  - 端口: 443 (HTTPS)                                    │  │
│  │  - 域名: api.xiaoliu.dev                               │  │
│  │  - 服务: Node.js + Express + PM2                       │  │
│  └───────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  📊 数据库层                                            │  │
│  │  - SQLite / PostgreSQL                                │  │
│  │  - 规则存储、监测日志、用户配置                          │  │
│  └───────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  📈 监控面板 (Dashboard)                               │  │
│  │  - 端口: 443 (HTTPS)                                    │  │
│  │  - 域名: dashboard.xiaoliu.dev                         │  │
│  │  - 实时监测、系统状态、升级管理                          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                           ↓
              ┌────────────┼────────────┐
              ↓            ↓            ↓
       ┌──────────┐  ┌──────────┐  ┌──────────┐
       │ 💻 电脑A   │  │ 💻 电脑B   │  │ 💻 电脑C   │
       │  Cursor  │  │  Cursor  │  │  Cursor  │
       │  窗口1-3  │  │  窗口1-2  │  │  窗口1-5  │
       └──────────┘  └──────────┘  └──────────┘
            ↓              ↓              ↓
       通过API调用云端规则引擎（HTTPS）
       ✅ 零安装，仅需配置API地址
       ✅ 自动获取最新规则
       ✅ 实时同步监测数据
```

---

## 2. 核心组件设计

### 2.1 云端API服务

**职责：**
- 提供规则检查API
- 提供配置管理API
- 提供监测数据收集API
- 提供版本查询API

**技术栈：**
```javascript
// 云端API服务架构
Express.js (API框架)
  ↓
PM2 (进程管理)
  ↓
PostgreSQL / SQLite (数据存储)
  ↓
Redis (缓存层，可选)
  ↓
Nginx (反向代理 + HTTPS)
```

**关键API端点：**
```
# 规则检查
POST https://api.xiaoliu.dev/v1/check-code
POST https://api.xiaoliu.dev/v1/check-dialogue

# 配置管理
GET  https://api.xiaoliu.dev/v1/config
GET  https://api.xiaoliu.dev/v1/rules/latest
GET  https://api.xiaoliu.dev/v1/version

# 监测数据
POST https://api.xiaoliu.dev/v1/monitor/log
GET  https://api.xiaoliu.dev/v1/monitor/stats

# 团队协作
GET  https://api.xiaoliu.dev/v1/team/config
POST https://api.xiaoliu.dev/v1/team/meeting

# 自我介绍
GET  https://api.xiaoliu.dev/v1/intro
```

---

### 2.2 客户端轻量适配器

**职责：**
- 拦截Cursor的代码保存事件
- 调用云端API进行规则检查
- 缓存规则减少网络请求
- 本地降级（云端不可用时）

**实现方式：**
```javascript
// cursor-xiaoliu-client.js (轻量客户端)
const XiaoliuClient = {
  apiBase: 'https://api.xiaoliu.dev/v1',
  cacheRules: null,
  cacheTTL: 5 * 60 * 1000, // 5分钟缓存
  
  async checkCode(code, filename) {
    try {
      // 1. 尝试云端检查
      const response = await fetch(`${this.apiBase}/check-code`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, filename })
      });
      
      if (response.ok) {
        return await response.json();
      }
      
      // 2. 降级到本地缓存规则
      return this.checkCodeLocally(code, filename);
    } catch (error) {
      // 3. 网络错误，使用本地规则
      return this.checkCodeLocally(code, filename);
    }
  },
  
  async syncRules() {
    // 定期同步最新规则到本地缓存
    const response = await fetch(`${this.apiBase}/rules/latest`);
    this.cacheRules = await response.json();
  }
};
```

**安装方式：**
```bash
# 方式1: NPM包（推荐）
npm install -g xiaoliu-client
xiaoliu-client init

# 方式2: VSCode插件
在VSCode插件市场搜索 "小柳助手"，安装即可

# 方式3: Cursor配置
在.cursor/settings.json中添加：
{
  "xiaoliu.apiUrl": "https://api.xiaoliu.dev/v1",
  "xiaoliu.enabled": true
}
```

---

### 2.3 实时升级机制

**核心原理：**
```
云端升级流程:
1. 管理员在云端更新规则/代码
2. 云端自动重启服务（PM2优雅重启，零停机）
3. 客户端下次请求自动获取最新规则
4. 可选：WebSocket推送通知客户端立即更新
```

**实施方案：**

#### 方案A：被动拉取（简单）
```javascript
// 客户端定期检查版本
setInterval(async () => {
  const remoteVersion = await fetch('https://api.xiaoliu.dev/v1/version');
  if (remoteVersion.data.version > localVersion) {
    console.log('发现新版本，自动更新规则...');
    await syncRules();
  }
}, 60000); // 每分钟检查一次
```

**优点：** 简单，无需额外服务  
**缺点：** 最多延迟1分钟

---

#### 方案B：WebSocket推送（推荐）
```javascript
// 云端推送通知
const io = require('socket.io');
const server = io.listen(3001);

// 管理员升级后触发
server.emit('upgrade', {
  version: 'v6.2.0',
  message: '新增P0修复，请刷新规则'
});

// 客户端接收
const socket = io('wss://api.xiaoliu.dev');
socket.on('upgrade', (data) => {
  console.log('云端已升级:', data.message);
  syncRules(); // 立即同步
});
```

**优点：** 实时推送，秒级生效  
**缺点：** 需要维护WebSocket连接

---

#### 方案C：HTTP长轮询（备选）
```javascript
// 客户端长轮询
async function waitForUpgrade() {
  const response = await fetch('https://api.xiaoliu.dev/v1/wait-upgrade', {
    timeout: 30000 // 30秒超时
  });
  
  if (response.ok) {
    const upgrade = await response.json();
    console.log('检测到升级:', upgrade);
    await syncRules();
  }
  
  // 继续下一次轮询
  waitForUpgrade();
}
```

**优点：** 兼容性好，无需WebSocket  
**缺点：** 服务器资源占用稍高

---

## 🚀 第二部分：部署方案

---

## 3. 云服务商选择

### 3.1 免费/低成本方案（推荐入门）

#### ⭐ 方案1: Vercel + Serverless（免费）

**优势：**
- ✅ 完全免费（个人使用）
- ✅ 自动HTTPS
- ✅ 全球CDN加速
- ✅ 自动部署（Git推送即部署）
- ✅ 零运维

**限制：**
- ⚠️ 每次请求最多10秒执行时间
- ⚠️ 无法使用WebSocket
- ⚠️ SQLite受限（推荐用Vercel KV或PostgreSQL）

**部署步骤：**
```bash
# 1. 安装Vercel CLI
npm install -g vercel

# 2. 登录
vercel login

# 3. 部署
cd 【项目】开发材料
vercel deploy --prod

# 4. 自动获得域名
# https://xiaoliu-api-xxx.vercel.app
```

**配置示例：**
```json
// vercel.json
{
  "version": 2,
  "builds": [
    {
      "src": "scripts/core/rule-engine-server.cjs",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/v1/(.*)",
      "dest": "scripts/core/rule-engine-server.cjs"
    }
  ],
  "env": {
    "NODE_ENV": "production"
  }
}
```

---

#### ⭐ 方案2: Railway（免费额度）

**优势：**
- ✅ 每月$5免费额度（足够小规模使用）
- ✅ 支持WebSocket
- ✅ 支持PostgreSQL数据库
- ✅ 支持持久化存储
- ✅ 自动HTTPS
- ✅ Git推送自动部署

**部署步骤：**
```bash
# 1. 访问 https://railway.app
# 2. 连接GitHub仓库
# 3. 选择 daxiak001/cursor-mcp
# 4. 自动部署，获得域名
# 5. 配置环境变量（可选）
```

**成本预估：**
- 免费额度：$5/月（约500小时运行时间）
- 超出后：$0.000463/GB-秒

---

#### ⭐ 方案3: Render（免费）

**优势：**
- ✅ 完全免费的Web Service
- ✅ 自动HTTPS
- ✅ 支持PostgreSQL
- ✅ Git自动部署

**限制：**
- ⚠️ 15分钟无请求会休眠（首次访问需要30秒唤醒）
- ⚠️ 每月750小时免费（够用）

**部署步骤：**
```bash
# 1. 访问 https://render.com
# 2. New > Web Service
# 3. 连接GitHub: daxiak001/cursor-mcp
# 4. 配置:
#    - Build Command: npm install
#    - Start Command: node scripts/core/rule-engine-server.cjs
# 5. 部署完成
```

---

### 3.2 企业级方案（生产环境）

#### 🏢 方案4: 阿里云/腾讯云（推荐国内）

**配置建议：**
- **服务器：** 轻量应用服务器 2核2G（¥70-100/月）
- **数据库：** RDS PostgreSQL 或 自建
- **域名：** 自定义域名 + SSL证书
- **CDN：** 可选，加速API访问

**部署步骤：**
```bash
# 1. 购买服务器（Ubuntu 20.04）
# 2. 配置环境
ssh root@your-server-ip
apt update
apt install -y nodejs npm nginx
npm install -g pm2

# 3. 上传代码
git clone git@github.com:daxiak001/cursor-mcp.git
cd cursor-mcp/【项目】开发材料

# 4. 安装依赖
npm install

# 5. 启动服务
pm2 start scripts/core/rule-engine-server.cjs --name xiaoliu-api
pm2 startup  # 开机自启
pm2 save

# 6. 配置Nginx反向代理
nano /etc/nginx/sites-available/xiaoliu
```

**Nginx配置：**
```nginx
server {
    listen 80;
    server_name api.xiaoliu.dev;
    
    # 自动跳转HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.xiaoliu.dev;
    
    # SSL证书（Let's Encrypt免费）
    ssl_certificate /etc/letsencrypt/live/api.xiaoliu.dev/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.xiaoliu.dev/privkey.pem;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**成本预估：**
- 服务器：¥70-100/月
- 域名：¥50-100/年
- SSL证书：免费（Let's Encrypt）
- **总计：** ¥80-110/月

---

#### 🏢 方案5: AWS/Azure/GCP（国际）

**推荐配置：**
- **EC2 t3.micro**（AWS）：1核1G，免费12个月
- **App Service B1**（Azure）：1核1.75G，约$13/月
- **Cloud Run**（GCP）：按请求计费，低流量免费

**优势：**
- 全球访问速度快
- 可扩展性强
- 企业级SLA保障

---

## 4. 多终端配置方案

### 4.1 Cursor配置（所有电脑通用）

**方式1：通过VSCode插件（推荐）**

```bash
# 1. 安装小柳插件（发布后）
在Cursor扩展市场搜索 "Xiaoliu Assistant"

# 2. 配置API地址
File > Preferences > Settings
搜索 "Xiaoliu"
设置:
  - API URL: https://api.xiaoliu.dev/v1
  - Enable: ✅
  - Auto Update: ✅

# 3. 完成！所有窗口自动生效
```

---

**方式2：通过.cursorrc配置文件**

```json
// ~/.cursorrc（所有Cursor窗口共享）
{
  "xiaoliu": {
    "enabled": true,
    "apiUrl": "https://api.xiaoliu.dev/v1",
    "apiKey": "your-api-key-optional",
    "autoUpdate": true,
    "cacheTime": 300000,
    "offline": {
      "enabled": true,
      "fallbackRules": "./local-rules.yaml"
    }
  }
}
```

**配置说明：**
- `apiUrl`: 云端API地址
- `apiKey`: 可选，用于身份验证
- `autoUpdate`: 自动获取最新规则
- `cacheTime`: 本地缓存时间（毫秒）
- `offline`: 离线降级配置

---

**方式3：通过MCP服务器配置**

```json
// Cursor MCP配置
{
  "mcpServers": {
    "xiaoliu": {
      "command": "npx",
      "args": ["-y", "xiaoliu-mcp-server"],
      "env": {
        "XIAOLIU_API_URL": "https://api.xiaoliu.dev/v1",
        "XIAOLIU_AUTO_UPDATE": "true"
      }
    }
  }
}
```

---

### 4.2 多电脑同步策略

**方案A：统一配置文件（推荐）**

```bash
# 1. 将配置文件保存到云盘
# 比如：Dropbox/OneDrive/iCloud

# 2. 在每台电脑创建软链接
# Windows:
mklink %USERPROFILE%\.cursorrc "D:\Dropbox\.cursorrc"

# Mac/Linux:
ln -s ~/Dropbox/.cursorrc ~/.cursorrc

# 3. 所有电脑自动同步配置
```

---

**方案B：云端配置管理**

```javascript
// 云端提供配置管理API
GET https://api.xiaoliu.dev/v1/config?user=your-email

// 返回个性化配置
{
  "rules": ["IR-001", "IR-002", ...],
  "preferences": {
    "autoFix": true,
    "strictMode": false
  },
  "team": {
    "mode": "four-roles",
    "members": [...]
  }
}

// 客户端自动应用
```

**优势：**
- ✅ 无需手动同步
- ✅ 支持多用户
- ✅ 随时随地访问
- ✅ 在线修改立即生效

---

## 🔧 第三部分：技术实施细节

---

## 5. 云端API服务改造

### 5.1 现有代码适配（最小改动）

**当前架构：**
```
scripts/core/rule-engine-server.cjs  (本地服务)
  ↓
本地运行，监听 localhost:3000
```

**云端适配：**
```javascript
// scripts/core/rule-engine-server-cloud.cjs
const express = require('express');
const cors = require('cors');
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');

const app = express();

// 1. 安全加固
app.use(helmet()); // 安全头
app.use(cors({      // 跨域配置
  origin: process.env.ALLOWED_ORIGINS?.split(',') || '*',
  credentials: true
}));

// 2. 限流保护
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100 // 限制100次请求
});
app.use('/v1/', limiter);

// 3. API版本化
app.use('/v1', require('./rule-engine-api-v1'));

// 4. 健康检查（云平台要求）
app.get('/health', (req, res) => {
  res.json({ 
    status: 'healthy', 
    version: require('../../version.json').version,
    uptime: process.uptime()
  });
});

// 5. 监听端口（从环境变量读取）
const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`☁️ 小柳云端API启动成功: ${PORT}`);
});
```

---

### 5.2 数据库升级（SQLite → PostgreSQL）

**为什么需要升级？**
- SQLite不支持并发写入
- 云端多实例部署需要共享数据库
- PostgreSQL性能更好，功能更强

**迁移方案：**
```bash
# 1. 导出SQLite数据
sqlite3 data/xiaoliu.db .dump > backup.sql

# 2. 转换为PostgreSQL格式
# 使用工具: pgloader
pgloader xiaoliu.db postgresql://user:pass@host/dbname

# 3. 更新代码
# 替换所有 sqlite3 为 pg 库
npm install pg
```

**代码示例：**
```javascript
// scripts/core/db-adapter.cjs（数据库抽象层）
const dbType = process.env.DB_TYPE || 'sqlite';

let db;
if (dbType === 'sqlite') {
  const sqlite3 = require('sqlite3');
  db = new sqlite3.Database('./data/xiaoliu.db');
} else if (dbType === 'postgresql') {
  const { Pool } = require('pg');
  db = new Pool({
    connectionString: process.env.DATABASE_URL
  });
}

// 统一的查询接口
async function query(sql, params) {
  if (dbType === 'sqlite') {
    return new Promise((resolve, reject) => {
      db.all(sql, params, (err, rows) => {
        if (err) reject(err);
        else resolve(rows);
      });
    });
  } else {
    const result = await db.query(sql, params);
    return result.rows;
  }
}

module.exports = { query };
```

---

### 5.3 实时升级推送机制

**WebSocket实现：**
```javascript
// scripts/core/upgrade-notifier.cjs
const { Server } = require('socket.io');

class UpgradeNotifier {
  constructor(httpServer) {
    this.io = new Server(httpServer, {
      cors: { origin: '*' }
    });
    
    this.io.on('connection', (socket) => {
      console.log('客户端连接:', socket.id);
      
      // 发送当前版本
      socket.emit('version', {
        current: this.currentVersion
      });
    });
  }
  
  notifyUpgrade(version, changelog) {
    // 广播给所有连接的客户端
    this.io.emit('upgrade', {
      version,
      changelog,
      timestamp: Date.now()
    });
  }
}

module.exports = UpgradeNotifier;
```

**客户端接收：**
```javascript
// cursor-xiaoliu-client.js
const io = require('socket.io-client');

const socket = io('https://api.xiaoliu.dev', {
  transports: ['websocket']
});

socket.on('upgrade', async (data) => {
  console.log(`🚀 检测到升级: ${data.version}`);
  console.log(`📋 更新内容: ${data.changelog}`);
  
  // 提示用户
  vscode.window.showInformationMessage(
    `小柳系统已升级到 ${data.version}，正在自动更新...`
  );
  
  // 重新加载规则
  await syncRules();
  
  vscode.window.showInformationMessage('✅ 升级完成！');
});
```

---

## 6. 客户端轻量插件开发

### 6.1 VSCode扩展结构

```
xiaoliu-cursor-extension/
├── package.json           - 插件配置
├── src/
│   ├── extension.ts      - 主入口
│   ├── api-client.ts     - API客户端
│   ├── rule-checker.ts   - 规则检查器
│   └── config.ts         - 配置管理
├── README.md
└── CHANGELOG.md
```

**核心代码：**
```typescript
// src/extension.ts
import * as vscode from 'vscode';
import { XiaoliuApiClient } from './api-client';
import { RuleChecker } from './rule-checker';

export function activate(context: vscode.ExtensionContext) {
  console.log('🎉 小柳助手已激活');
  
  // 1. 初始化API客户端
  const config = vscode.workspace.getConfiguration('xiaoliu');
  const apiUrl = config.get<string>('apiUrl', 'https://api.xiaoliu.dev/v1');
  const client = new XiaoliuApiClient(apiUrl);
  
  // 2. 初始化规则检查器
  const checker = new RuleChecker(client);
  
  // 3. 监听文件保存事件
  context.subscriptions.push(
    vscode.workspace.onWillSaveTextDocument(async (event) => {
      const document = event.document;
      const code = document.getText();
      const filename = document.fileName;
      
      // 调用云端检查
      const violations = await checker.checkCode(code, filename);
      
      if (violations.length > 0) {
        // 显示问题
        showViolations(violations);
        
        // 可选：阻止保存
        if (config.get<boolean>('blockOnError')) {
          event.waitUntil(Promise.reject('代码质量检查未通过'));
        }
      }
    })
  );
  
  // 4. 实时升级监听
  client.onUpgrade((version) => {
    vscode.window.showInformationMessage(
      `小柳系统已升级到 ${version}，规则已自动更新`
    );
  });
}
```

---

### 6.2 发布到VSCode市场

**步骤：**
```bash
# 1. 安装发布工具
npm install -g vsce

# 2. 打包插件
cd xiaoliu-cursor-extension
vsce package

# 3. 登录Azure DevOps
# 创建Personal Access Token

# 4. 发布
vsce publish

# 5. 用户安装
# 在VSCode/Cursor中搜索 "Xiaoliu Assistant"
```

---

## 💰 第四部分：成本分析

---

## 7. 部署成本对比

### 7.1 免费方案对比

| 方案 | 月成本 | 适用场景 | 限制 |
|------|--------|----------|------|
| **Vercel** | ¥0 | 个人/小团队 | 10秒执行限制，无WebSocket |
| **Railway** | ¥0-35 | 小团队 | $5免费额度，超出按量计费 |
| **Render** | ¥0 | 个人 | 15分钟无请求休眠 |

**推荐：** Railway（平衡性能和成本）

---

### 7.2 企业方案对比

| 方案 | 月成本 | 适用场景 | 优势 |
|------|--------|----------|------|
| **阿里云轻量** | ¥70-100 | 中小企业/国内 | 稳定、备案方便 |
| **腾讯云轻量** | ¥60-90 | 中小企业/国内 | 性价比高 |
| **AWS EC2** | $8-15 | 国际业务 | 全球部署，可扩展 |
| **自建服务器** | ¥300-500 | 大团队 | 完全控制，性能最高 |

**推荐：** 
- 国内用户：阿里云/腾讯云
- 国际用户：AWS/Railway

---

### 7.3 总成本估算（首年）

#### 场景1：个人使用
```
☁️ 云服务: Railway免费版            ¥0
🌐 域名:   可选，使用默认域名         ¥0
📦 插件:   开源免费                  ¥0
───────────────────────────────────
总计:                              ¥0/年
```

#### 场景2：小团队（5-10人）
```
☁️ 云服务: Railway付费版            ¥35/月
🌐 域名:   自定义域名                ¥50/年
🔐 SSL:    Let's Encrypt免费        ¥0
📦 插件:   开源免费                  ¥0
───────────────────────────────────
总计:                     ¥470/年 (约¥40/月)
```

#### 场景3：中型团队（10-50人）
```
☁️ 云服务: 阿里云轻量2核2G          ¥90/月
🌐 域名:   自定义域名                ¥50/年
🔐 SSL:    Let's Encrypt免费        ¥0
💾 数据库: RDS PostgreSQL          ¥100/月
📊 监控:   阿里云监控免费版          ¥0
───────────────────────────────────
总计:                   ¥2,330/年 (约¥194/月)
```

---

## 🎯 第五部分：实施计划

---

## 8. 分阶段实施

### 阶段1：基础云端部署（1周）

**目标：** 实现基本的云端API服务

**任务清单：**
- [ ] 选择云服务商（推荐Railway）
- [ ] 改造rule-engine-server为云端版本
- [ ] 添加CORS、限流、安全加固
- [ ] 部署到云端，获得API地址
- [ ] 测试API端点可用性

**交付物：**
- ✅ 云端API服务正常运行
- ✅ API文档（Postman/Swagger）
- ✅ 健康检查端点

**验收标准：**
```bash
# 1. 健康检查
curl https://api.xiaoliu.dev/health
# 返回: {"status":"healthy","version":"v6.1.1"}

# 2. 规则检查
curl -X POST https://api.xiaoliu.dev/v1/check-code \
  -H "Content-Type: application/json" \
  -d '{"code":"const password = \"123456\"","filename":"test.js"}'
# 返回: {"violations":[...]}
```

---

### 阶段2：客户端适配（1周）

**目标：** 开发轻量客户端，支持多终端访问

**任务清单：**
- [ ] 开发VSCode插件骨架
- [ ] 实现API客户端模块
- [ ] 实现规则检查器
- [ ] 实现本地缓存机制
- [ ] 实现离线降级

**交付物：**
- ✅ VSCode插件（.vsix）
- ✅ 配置文件模板
- ✅ 使用文档

**验收标准：**
- ✅ 安装插件后能调用云端API
- ✅ 保存代码时自动检查
- ✅ 云端不可用时自动降级

---

### 阶段3：实时升级（1周）

**目标：** 实现云端升级，客户端自动更新

**任务清单：**
- [ ] 开发WebSocket推送服务
- [ ] 客户端实现升级监听
- [ ] 实现规则热更新
- [ ] 实现版本管理API
- [ ] 测试多客户端同步

**交付物：**
- ✅ WebSocket服务
- ✅ 升级通知机制
- ✅ 升级日志系统

**验收标准：**
```bash
# 1. 云端升级
# 管理员执行：
node scripts/tools/bump-version.cjs --minor
git push origin main

# 2. 客户端自动检测（30秒内）
# Cursor窗口显示：
# 🚀 小柳系统已升级到 v6.2.0，规则已自动更新

# 3. 验证生效
# 新规则立即可用
```

---

### 阶段4：多终端同步（3天）

**目标：** 实现配置云端管理，多设备同步

**任务清单：**
- [ ] 开发用户配置API
- [ ] 实现配置云端存储
- [ ] 客户端自动同步配置
- [ ] 测试多设备一致性

**交付物：**
- ✅ 配置管理面板
- ✅ 用户配置API
- ✅ 多设备同步文档

---

### 阶段5：监控面板（1周，可选）

**目标：** 可视化监控系统运行状态

**任务清单：**
- [ ] 开发Web Dashboard
- [ ] 实时显示API调用量
- [ ] 显示规则拦截统计
- [ ] 显示在线客户端数量
- [ ] 升级管理界面

**交付物：**
- ✅ Dashboard网站（https://dashboard.xiaoliu.dev）
- ✅ 实时监控图表
- ✅ 管理员操作界面

---

## 📋 第六部分：操作手册

---

## 9. 快速开始

### 9.1 云端部署（Railway示例）

**步骤1：创建Railway项目**
```bash
# 1. 访问 https://railway.app
# 2. 使用GitHub登录
# 3. New Project > Deploy from GitHub repo
# 4. 选择: daxiak001/cursor-mcp
```

**步骤2：配置环境变量**
```bash
# Railway Dashboard > Variables
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://... (Railway自动提供)
ALLOWED_ORIGINS=https://cursor.sh,http://localhost
```

**步骤3：配置启动命令**
```bash
# Build Command
npm install

# Start Command  
node 【项目】开发材料/scripts/core/rule-engine-server.cjs
```

**步骤4：获取域名**
```bash
# Railway自动分配域名
# 示例: xiaoliu-api-production.up.railway.app

# 可选：绑定自定义域名
# Settings > Domains > Add Custom Domain
# 输入: api.xiaoliu.dev
# 配置DNS CNAME记录
```

---

### 9.2 客户端配置（所有电脑）

**方式1：VSCode插件（最简单）**
```bash
# 1. 打开Cursor
# 2. Ctrl+Shift+X 打开扩展
# 3. 搜索 "Xiaoliu Assistant"
# 4. 点击 Install
# 5. 配置API地址：
#    Settings > Xiaoliu > API URL
#    输入: https://xiaoliu-api-production.up.railway.app/v1
# 6. 完成！
```

**方式2：手动配置文件**
```bash
# 创建配置文件
# Windows: %USERPROFILE%\.cursorrc
# Mac/Linux: ~/.cursorrc

# 内容:
{
  "xiaoliu": {
    "enabled": true,
    "apiUrl": "https://xiaoliu-api-production.up.railway.app/v1",
    "autoUpdate": true
  }
}
```

---

### 9.3 验证部署

**测试1：健康检查**
```bash
curl https://xiaoliu-api-production.up.railway.app/health

# 期望输出:
{
  "status": "healthy",
  "version": "v6.1.1",
  "uptime": 12345
}
```

**测试2：规则检查**
```bash
curl -X POST https://xiaoliu-api-production.up.railway.app/v1/check-code \
  -H "Content-Type: application/json" \
  -d '{
    "code": "const apiKey = \"sk-12345\";",
    "filename": "test.js"
  }'

# 期望输出:
{
  "violations": [
    {
      "ruleId": "IR-003",
      "message": "检测到硬编码的API密钥",
      "severity": "error",
      "line": 1
    }
  ]
}
```

**测试3：版本查询**
```bash
curl https://xiaoliu-api-production.up.railway.app/v1/version

# 期望输出:
{
  "version": "v6.1.1",
  "releaseDate": "2025-10-08",
  "changelog": "..."
}
```

---

## 10. 升级流程

### 10.1 云端升级（管理员）

**步骤：**
```bash
# 1. 本地修改代码/规则
cd 【项目】开发材料

# 2. 运行升级工具
node scripts/tools/bump-version.cjs --patch
# 自动更新 version.json

# 3. 提交到Git
git add -A
git commit -m "v6.1.2 - 修复XXX问题"
git push origin main

# 4. Railway自动部署（约30秒）
# 查看日志: Railway Dashboard > Deployments

# 5. 通知所有客户端（自动）
# WebSocket自动推送升级通知
```

---

### 10.2 客户端自动更新

**流程：**
```
1. 云端升级完成
   ↓
2. WebSocket推送通知
   ↓
3. 客户端收到通知
   ↓
4. 后台下载最新规则
   ↓
5. 自动应用，无需重启
   ↓
6. 显示通知：✅ 已升级到 v6.1.2
```

**用户体验：**
- ✅ 完全自动，无需操作
- ✅ 不影响当前工作
- ✅ 30秒内生效
- ✅ 失败自动回滚

---

## 🎁 第七部分：额外功能

---

## 11. 高级特性

### 11.1 多用户/团队支持

**功能：**
- 每个用户独立配置
- 团队共享规则库
- 权限管理（管理员/成员）
- 使用统计

**实现：**
```javascript
// API: 用户登录
POST /v1/auth/login
{
  "email": "user@example.com",
  "password": "xxx"
}

// 返回Token
{
  "token": "jwt-token",
  "user": {
    "id": "user-123",
    "name": "张三",
    "team": "开发团队A"
  }
}

// 后续请求带Token
headers: {
  "Authorization": "Bearer jwt-token"
}

// API自动返回用户专属配置
```

---

### 11.2 规则市场

**功能：**
- 官方规则库
- 社区贡献规则
- 一键安装规则包
- 规则评分/评论

**实现：**
```javascript
// API: 浏览规则市场
GET /v1/marketplace/rules?category=security

// 安装规则包
POST /v1/marketplace/install
{
  "packageId": "security-best-practices",
  "version": "1.0.0"
}

// 自动添加到用户规则库
```

---

### 11.3 AI智能建议

**功能：**
- 基于项目自动推荐规则
- 学习用户习惯
- 智能修复建议
- 代码优化建议

**实现：**
```javascript
// API: AI建议
POST /v1/ai/suggest
{
  "code": "...",
  "context": {
    "projectType": "web",
    "framework": "react"
  }
}

// 返回智能建议
{
  "suggestions": [
    {
      "type": "optimization",
      "message": "建议使用useMemo优化性能",
      "code": "const value = useMemo(...);"
    }
  ]
}
```

---

## 📊 第八部分：效果评估

---

## 12. 预期效果

### 12.1 功能对比

| 维度 | 当前本地版 | 云端版 |
|------|-----------|--------|
| **部署方式** | 每台电脑独立安装 | 云端统一部署 |
| **升级方式** | 手动更新代码 | 自动推送升级 |
| **配置同步** | 手动复制配置 | 自动云端同步 |
| **多窗口支持** | 需要重复配置 | 自动共享 |
| **跨设备** | 不支持 | ✅ 支持 |
| **团队协作** | 困难 | ✅ 简单 |
| **维护成本** | 高 | 低 |
| **可靠性** | 依赖本地 | 云端高可用 |

---

### 12.2 性能对比

| 指标 | 本地版 | 云端版 |
|------|--------|--------|
| **规则检查延迟** | ~5ms | ~50-100ms（首次），~10ms（缓存后） |
| **启动时间** | ~500ms | ~0ms（无需启动） |
| **内存占用** | ~100MB/窗口 | ~0MB（客户端轻量） |
| **磁盘占用** | ~500MB | ~5MB（插件） |
| **升级时间** | ~5分钟 | ~30秒（自动） |

**结论：** 云端版在便利性上远超本地版，性能略有损失但可接受

---

### 12.3 用户体验提升

**场景1：新电脑使用**
```
本地版:
1. 安装Node.js (10分钟)
2. 克隆代码 (5分钟)
3. 安装依赖 (5分钟)
4. 配置环境 (10分钟)
5. 启动服务 (2分钟)
总计: 32分钟

云端版:
1. 安装插件 (30秒)
2. 配置API地址 (10秒)
总计: 40秒

⚡ 提升48倍！
```

**场景2：系统升级**
```
本地版:
1. git pull (1分钟)
2. npm install (3分钟)
3. 重启服务 (30秒)
4. 多台电脑重复 (×N)
总计: 4.5分钟 × N台

云端版:
1. 管理员git push (1分钟)
2. 自动部署 (30秒)
3. 所有客户端自动更新 (30秒)
总计: 2分钟（无论多少台）

⚡ N台电脑节省 (4.5N-2) 分钟
```

**场景3：多窗口切换**
```
本地版:
- 每个窗口独立检查
- 内存占用 100MB × N个窗口

云端版:
- 所有窗口共享云端服务
- 内存占用 5MB（插件）
- 响应时间一致

⚡ 内存节省 90%+
```

---

## 🎯 总结与建议

---

## 13. 方案总结

### 13.1 核心优势

✅ **多终端访问** - 任意电脑、任意Cursor窗口无缝使用  
✅ **实时升级** - 云端升级，所有终端30秒内生效  
✅ **零安装** - 仅需安装轻量插件，无需配置环境  
✅ **统一管理** - 规则、配置、监测数据集中管理  
✅ **成本可控** - 免费方案可用，付费方案≤¥200/月  
✅ **高可用** - 云服务商保障99.9%在线率  

---

### 13.2 实施建议

#### 短期（1-2周）
```
推荐方案: Railway + VSCode插件
投入: 0-2天开发 + ¥0-35/月
产出: 完整的云端服务 + 多终端支持
```

**适用场景：**
- 个人使用
- 小团队（5-10人）
- 快速验证云端方案

---

#### 中期（1-2月）
```
推荐方案: 阿里云/腾讯云 + 自定义域名 + Dashboard
投入: 3-5天开发 + ¥90-200/月
产出: 企业级服务 + 监控面板 + 高性能
```

**适用场景：**
- 中型团队（10-50人）
- 需要自定义功能
- 重视稳定性和性能

---

#### 长期（3-6月）
```
推荐方案: 多区域部署 + 规则市场 + AI智能
投入: 持续开发 + ¥500-2000/月
产出: SaaS产品 + 商业化能力
```

**适用场景：**
- 大型企业
- 产品商业化
- 社区生态建设

---

### 13.3 立即行动

#### 最简单方案（1小时上线）

**步骤1：部署到Railway（10分钟）**
```bash
# 1. 访问 https://railway.app
# 2. 连接GitHub: daxiak001/cursor-mcp
# 3. 点击 Deploy
# 4. 等待部署完成
# 5. 获取域名（如：xiaoliu-api.up.railway.app）
```

**步骤2：配置客户端（5分钟）**
```bash
# 在任意Cursor窗口
# 1. 创建文件: ~/.cursorrc
# 2. 内容:
{
  "xiaoliu": {
    "apiUrl": "https://xiaoliu-api.up.railway.app/v1"
  }
}
# 3. 重启Cursor
```

**步骤3：验证（5分钟）**
```bash
# 1. 打开任意代码文件
# 2. 写入: const password = "123456";
# 3. 保存
# 4. 查看是否有规则提示
```

**✅ 完成！** 现在所有电脑都能通过这个云端服务使用小柳系统了！

---

## 📞 支持与反馈

**GitHub Issues：** https://github.com/daxiak001/cursor-mcp/issues  
**文档更新：** 云端部署文档将持续更新  
**社区交流：** 欢迎提供反馈和改进建议

---

**报告编制：** 📋 产品经理·小品  
**技术审核：** 💻 技术开发·小柳  
**成本评估：** 👤 用户经理·小户  
**质量把关：** 👁️ 监督管理·小观

**版本：** v1.0  
**日期：** 2025-10-08  
**状态：** ✅ 方案完整，可立即实施

