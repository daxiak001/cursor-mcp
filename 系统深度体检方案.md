# 🏥 小柳v6.1系统深度体检方案

**体检时间**: 2025-10-07  
**系统版本**: v6.1 (Express + SQLite)  
**体检目的**: 全面评估系统健康状况，发现潜在问题，优化性能

---

## 📋 体检项目总览

### 🎯 体检维度（10大类，60+检查项）

| 维度 | 检查项数 | 优先级 | 说明 |
|------|---------|--------|------|
| **1. 核心服务健康** | 8项 | P0 | 规则引擎、数据库、API服务 |
| **2. 数据完整性** | 7项 | P0 | 数据库、规则、配置、日志 |
| **3. API功能验证** | 15项 | P0 | 所有API端点功能测试 |
| **4. 性能指标** | 10项 | P1 | 响应时间、吞吐量、资源占用 |
| **5. 安全审计** | 8项 | P0 | 权限、加密、注入防护 |
| **6. 集成兼容性** | 6项 | P1 | MCP、Cursor插件、工具链 |
| **7. 监控告警** | 5项 | P1 | 日志、监控、告警系统 |
| **8. 文档完整性** | 4项 | P2 | 文档、注释、README |
| **9. 代码质量** | 6项 | P1 | Lint、测试覆盖、技术债 |
| **10. 业务指标** | 5项 | P1 | 执行率、规则命中率、用户体验 |

---

## 🔬 详细体检项目

### 1️⃣ 核心服务健康检查（P0）

#### 1.1 规则引擎服务
- [ ] **服务状态检查**
  - PM2进程运行状态
  - 端口监听状态 (3000)
  - 进程内存占用
  - 进程CPU占用
  - 运行时长

- [ ] **规则加载验证**
  - 规则总数验证 (预期11条)
  - 规则分类验证 (code/dialogue/workflow)
  - 规则优先级排序
  - 规则冲突检测
  - 规则版本一致性

- [ ] **数据库连接**
  - SQLite连接状态
  - 数据库文件完整性
  - 数据库大小监控
  - 连接池状态（如适用）

#### 1.2 API服务健康
- [ ] **健康检查端点**
  - `/api/health` 响应时间 (<100ms)
  - 返回数据完整性
  - 服务模式验证 (sqlite)

- [ ] **错误率监控**
  - 5xx错误率 (目标<0.1%)
  - 4xx错误率
  - 超时率
  - 异常日志数量

#### 1.3 依赖服务
- [ ] **Node.js环境**
  - Node版本检查
  - npm包完整性
  - sql.js版本验证

- [ ] **PM2守护进程**
  - PM2版本
  - 自动重启配置
  - 日志轮转配置

---

### 2️⃣ 数据完整性检查（P0）

#### 2.1 数据库完整性
- [ ] **表结构验证**
  - 8张核心表存在性检查
  - 表字段完整性
  - 索引存在性 (12个索引)
  - 外键约束验证

- [ ] **数据一致性**
  - 规则表数据完整性 (11条)
  - 配置表预填充验证 (4条)
  - 审计日志连续性
  - 经验库数据质量

- [ ] **数据备份**
  - 备份文件存在性
  - 备份数据可恢复性
  - 备份策略有效性

#### 2.2 规则数据验证
- [ ] **核心规则验证**
  - IR-003: 禁止硬编码敏感信息
  - SIL-003: 禁止询问用户
  - SIL-004: 禁止等待用户
  - 其他8条规则

- [ ] **规则内容检查**
  - 规则模式正则有效性
  - 规则消息完整性
  - 规则优先级合理性

#### 2.3 配置数据
- [ ] **持久化配置**
  - ssh_port: 22
  - api_port: 8889
  - execution_rate_target: 95
  - 其他配置项

- [ ] **配置类型验证**
  - 类型转换正确性 (string/number/boolean/json)
  - 默认值有效性

---

### 3️⃣ API功能全面验证（P0）

#### 3.1 基础API（5个）
- [ ] **GET /api/health**
  - 响应时间 (<5ms)
  - 返回字段完整性
  - 规则数量正确性

- [ ] **POST /api/check-code**
  - 硬编码检测准确性
  - 函数长度检测
  - 命名规范检测
  - 性能 (<50ms)

- [ ] **POST /api/check-dialogue**
  - 询问检测准确性
  - 等待检测准确性
  - 性能 (<30ms)

- [ ] **POST /api/quality-gate**
  - 综合检测准确性
  - 核心违规识别
  - 门禁逻辑正确性

- [ ] **POST /api/reload-rules**
  - 规则重载成功率
  - 内存刷新有效性
  - 零停机时间

#### 3.2 规则管理API（4个）
- [ ] **GET /api/rules**
  - 全量规则返回
  - 分类查询功能
  - 类型查询功能

- [ ] **GET /api/rules/:id**
  - 单规则查询准确性
  - 不存在规则的404处理

- [ ] **POST /api/rules**
  - 新增规则成功
  - 更新规则成功
  - 数据验证有效性

- [ ] **DELETE /api/rules/:id**
  - 软删除成功
  - 级联处理正确性

#### 3.3 审计日志API（1个）
- [ ] **GET /api/audit-logs**
  - 日志查询功能
  - 过滤条件有效性
  - 分页功能（如有）
  - 日志数量统计

#### 3.4 经验库API（3个）
- [ ] **GET /api/lessons/search**
  - 关键词搜索准确性
  - 类型过滤功能
  - 排序逻辑（成功率/使用次数）

- [ ] **POST /api/lessons**
  - 经验记录成功
  - 数据格式验证

- [ ] **POST /api/lessons/:id/use**
  - 使用次数递增
  - 并发安全性

#### 3.5 配置管理API（2个）
- [ ] **GET /api/config/:key**
  - 配置读取准确性
  - 类型转换正确性
  - 不存在配置的404处理

- [ ] **POST /api/config**
  - 配置写入成功
  - 类型验证有效性
  - 持久化成功

---

### 4️⃣ 性能指标评估（P1）

#### 4.1 响应时间
- [ ] **API响应时间**
  - P50响应时间 (<20ms)
  - P95响应时间 (<50ms)
  - P99响应时间 (<100ms)
  - 最大响应时间

- [ ] **数据库查询性能**
  - 索引查询速度 (<10ms)
  - 全表扫描识别
  - 慢查询日志

- [ ] **规则检查性能**
  - 代码检查 (<50ms)
  - 对话检查 (<30ms)
  - 批量检查性能

#### 4.2 吞吐量
- [ ] **并发处理能力**
  - 单机QPS (目标>100)
  - 并发连接数
  - 请求队列长度

- [ ] **资源利用率**
  - CPU使用率 (目标<30%)
  - 内存使用率 (目标<500MB)
  - 磁盘I/O

#### 4.3 数据库性能
- [ ] **数据库操作性能**
  - INSERT速度 (<5ms)
  - SELECT速度 (<10ms)
  - UPDATE速度 (<5ms)
  - 数据库文件大小增长率

---

### 5️⃣ 安全审计（P0）

#### 5.1 输入验证
- [ ] **API输入验证**
  - SQL注入防护
  - XSS防护
  - 参数类型验证
  - 长度限制

- [ ] **规则模式安全**
  - 正则表达式DoS防护
  - 恶意模式检测

#### 5.2 数据安全
- [ ] **敏感数据保护**
  - 密码/Token加密存储
  - 日志脱敏
  - 配置加密（如需要）

- [ ] **访问控制**
  - API认证机制（如有）
  - 权限验证
  - 跨域配置

#### 5.3 代码安全
- [ ] **依赖安全**
  - npm audit检查
  - 已知漏洞扫描
  - 过期依赖检测

- [ ] **代码注入防护**
  - eval使用检查
  - 动态执行防护

---

### 6️⃣ 集成兼容性检查（P1）

#### 6.1 MCP集成
- [ ] **MCP拦截器**
  - respondToUser功能
  - writeFile功能
  - runCommand功能
  - completeTask功能

- [ ] **MCP调用链路**
  - MCP → 规则引擎调用
  - 规则检查结果返回
  - 错误处理机制

#### 6.2 Cursor插件集成
- [ ] **插件功能**
  - memoryEnhancer加载
  - contextSaver功能
  - 规则引擎调用

- [ ] **插件兼容性**
  - Cursor版本兼容
  - 配置同步

#### 6.3 工具链集成
- [ ] **PowerShell工具**
  - Invoke-XiaoliuSSH
  - Invoke-XiaoliuPython
  - Start-XiaoliuWatchdog

- [ ] **监控系统**
  - monitor-logger集成
  - dashboard集成
  - 告警系统

---

### 7️⃣ 监控告警系统（P1）

#### 7.1 日志系统
- [ ] **日志完整性**
  - 应用日志记录
  - 审计日志记录
  - 错误日志记录
  - 访问日志记录

- [ ] **日志质量**
  - 日志级别合理性
  - 日志格式统一性
  - 日志上下文完整性

#### 7.2 监控指标
- [ ] **系统监控**
  - CPU监控
  - 内存监控
  - 磁盘监控
  - 网络监控

- [ ] **业务监控**
  - 规则命中率
  - API调用统计
  - 错误率统计

#### 7.3 告警机制
- [ ] **告警规则**
  - 服务宕机告警
  - 性能降级告警
  - 错误率告警
  - 资源耗尽告警

---

### 8️⃣ 文档完整性（P2）

#### 8.1 技术文档
- [ ] **API文档**
  - 15个端点文档完整
  - 请求/响应示例
  - 错误码说明

- [ ] **部署文档**
  - 部署步骤清晰
  - 环境要求说明
  - 故障排查指南

#### 8.2 代码文档
- [ ] **代码注释**
  - 关键函数注释
  - 复杂逻辑说明
  - TODO项统计

- [ ] **README文件**
  - 项目介绍完整
  - 快速开始指南
  - 贡献指南

---

### 9️⃣ 代码质量（P1）

#### 9.1 静态分析
- [ ] **Linter检查**
  - ESLint规则遵守
  - 代码风格统一
  - 潜在问题识别

- [ ] **代码复杂度**
  - 圈复杂度 (目标<10)
  - 函数长度 (目标<50行)
  - 文件长度 (目标<500行)

#### 9.2 测试覆盖
- [ ] **单元测试**
  - 代码覆盖率 (当前100%)
  - 边界条件测试
  - 异常处理测试

- [ ] **集成测试**
  - 端到端测试 (当前11场景)
  - 接口测试 (当前10端点)
  - 性能测试

#### 9.3 技术债务
- [ ] **技术债务评估**
  - TODO项统计
  - FIXME项统计
  - 过时依赖
  - 重复代码识别

---

### 🔟 业务指标评估（P1）

#### 10.1 执行率监控
- [ ] **规则执行率**
  - 当前执行率统计
  - 与目标对比 (95%)
  - 提升空间分析

- [ ] **规则命中分析**
  - 各规则命中率
  - 高频违规识别
  - 规则优化建议

#### 10.2 用户体验
- [ ] **响应性能**
  - 平均响应时间
  - 卡顿情况统计
  - 超时情况分析

- [ ] **错误体验**
  - 错误提示清晰度
  - 错误恢复能力
  - 用户操作流畅度

#### 10.3 系统稳定性
- [ ] **可用性**
  - 系统正常运行时间比例 (目标>99.9%)
  - 故障恢复时间 (目标<5分钟)
  - 数据丢失率 (目标0%)

- [ ] **可靠性**
  - 规则检测准确率 (目标>99%)
  - 误报率 (目标<1%)
  - 漏报率 (目标<1%)

---

## 🛠️ 体检工具脚本

### 自动化体检脚本设计

```javascript
// scripts/health-check-comprehensive.cjs
// 综合健康检查脚本
```

**脚本功能**:
1. 自动执行所有体检项
2. 生成体检报告
3. 问题分级（Critical/High/Medium/Low）
4. 自动修复建议
5. 趋势分析（对比历史数据）

---

## 📊 体检报告模板

### 报告结构

```markdown
# 系统健康体检报告

## 执行摘要
- 体检时间: YYYY-MM-DD HH:mm:ss
- 体检耗时: XX分钟
- 检查项总数: 74项
- 通过项: XX项 (XX%)
- 警告项: XX项
- 错误项: XX项

## 关键发现
1. [Critical] XXX
2. [High] XXX
3. [Medium] XXX

## 详细结果
### 1. 核心服务健康
- ✅ 规则引擎服务: 正常
- ✅ 数据库连接: 正常
...

## 改进建议
1. 立即处理（Critical）
2. 短期优化（High）
3. 中期规划（Medium）
4. 长期建设（Low）

## 趋势分析
- 与上次体检对比
- 性能变化趋势
- 问题改善情况
```

---

## 🚀 执行计划

### 体检执行步骤

**阶段1: 准备阶段** (10分钟)
1. 备份当前数据库
2. 记录当前系统状态
3. 准备体检工具

**阶段2: 自动检查** (20分钟)
1. 执行自动化脚本
2. 收集系统指标
3. 生成初步报告

**阶段3: 手动验证** (15分钟)
1. 核心功能手动测试
2. 边界条件验证
3. 异常场景模拟

**阶段4: 报告生成** (10分钟)
1. 汇总检查结果
2. 生成详细报告
3. 提出改进建议

**阶段5: 问题修复** (根据优先级)
1. Critical问题立即修复
2. High问题当天修复
3. Medium问题本周修复
4. Low问题纳入规划

---

## ✅ 体检检查清单

### P0 - 必须检查（33项）
- [ ] 核心服务运行状态
- [ ] 数据库完整性
- [ ] 15个API功能
- [ ] 规则数据验证
- [ ] 安全漏洞扫描
- [ ] 关键性能指标
- [ ] ...

### P1 - 重要检查（25项）
- [ ] 性能深度分析
- [ ] 集成兼容性
- [ ] 监控告警系统
- [ ] 代码质量
- [ ] 业务指标
- [ ] ...

### P2 - 建议检查（16项）
- [ ] 文档完整性
- [ ] 代码注释
- [ ] 技术债务
- [ ] 用户体验优化
- [ ] ...

---

## 📈 成功标准

### 体检合格标准

**必须满足（P0）**:
- ✅ 核心服务100%正常
- ✅ 数据完整性100%
- ✅ API功能100%可用
- ✅ 无Critical安全问题
- ✅ 关键性能指标达标

**期望满足（P1）**:
- ✅ 性能指标优秀
- ✅ 集成100%兼容
- ✅ 监控告警有效
- ✅ 代码质量优秀
- ✅ 业务指标达标

**建议满足（P2）**:
- ✅ 文档100%完整
- ✅ 技术债务可控
- ✅ 用户体验良好

---

## 🎯 下一步行动

### 立即执行
1. **创建自动化体检脚本**
2. **执行首次完整体检**
3. **生成基线报告**
4. **修复Critical问题**

### 定期执行
- **每日**: 核心服务健康检查
- **每周**: 性能指标评估
- **每月**: 完整深度体检
- **每季度**: 架构优化评估

---

**体检方案制定完成时间**: 2025-10-07  
**预计首次体检耗时**: 55分钟  
**体检覆盖率**: 100%（10大维度，74个检查项）

