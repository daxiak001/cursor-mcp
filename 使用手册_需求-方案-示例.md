# 使用手册（需求 → 方案 → 示例）

目的：把你之前提出的诉求，用最直白的话说明“系统怎么帮你实现”，并配上最短可跑示例。

—

一、别把问题推到远端才发现（提交/推送前就拦）
- 方案：本地 Git Hooks（`hooks/pre-commit.ps1`、`hooks/pre-push.ps1`）自动跑：格式、静态扫描、硬编码扫描、单测与冒烟门禁。
- 怎么用：一次性执行
  ```powershell
  pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/setup.ps1
  ```
- 示例：提交前被拦时会在终端看到“硬编码可疑Top行”或“Top失败域（权重）”。修完再提交。

二、只跑必要测试，别全量（更快）
- 方案：差异选测 + 受影响域 + 域冒烟。
- 怎么用：
  ```powershell
  npm run ci:diff:pattern        # 输出 reports/diff-test-pattern.txt（只跑相关测试）
  npm run ci:domains             # 输出 reports/affected-domains.{txt,json}
  npm run ci:smoke:generate      # 为缺失域生成最小冒烟用例
  npm test                       # 跑测试
  npm run ci:smoke:analyze       # 输出权重通过率与Top失败域
  ```
- 看哪里：`reports/diff-test-pattern.txt`、`reports/smoke-analysis.{json,md}`。

三、接口别“说一套做一套”（契约一致）
- 方案：接口登记（`接口/模块接口清单.md`）+ 契约文件（`接口/contract.schema.json`） + 校验脚本（`scripts/interface_diff.cjs`、`scripts/contract_check.cjs`）。
- 怎么用：
  ```powershell
  npm run ci:interfaces   # 生成 reports/interface-diff.{json,md}
  npm run ci:contract     # 生成 reports/contract-check.{json,md}
  ```
- 示例：我们新增了 `src/utils/math.ts` 并登记 → 契约/接口差异报告会显示是否一致。

四、结果一眼看全（仪表板）
- 方案：汇总脚本 `scripts/run_reports.ps1` 统一生成总览。
- 怎么用：
  ```powershell
  npm run ci:all
  # 打开
  reports/ci-dashboard.md
  ```
- 看哪里：质量/覆盖率、策略映射、接口差异、契约检查、冒烟权重与门禁结果都在同一页罗列。

五、文档级占位运行（没装 Node 也能看流程）
- 方案：预检/覆盖率/策略报告支持占位产物，不卡死流程。
- 怎么用：
  ```powershell
  # 不安装 Node 也可
  npm run ci:reports
  # 产物：reports/coverage-summary.txt、coverage/coverage-summary.json（占位）、reports/policy-report.md、reports/ci-dashboard.md
  ```

六、开关怎么管（需要时再看）
- 钩子：`git config core.hooksPath hooks` / `git config --unset core.hooksPath`
- 冒烟门禁强度：`policy/quality-gates.json`（mode: warn|fail, 阈值 weighted_pass_threshold）
- 覆盖率门槛：`policy/routing.json`、`policy/domain-thresholds.json`（取更高）
- 自动确认模式：`scripts/enable_auto_confirm.ps1` / `scripts/disable_auto_confirm.ps1`

—

最短上手路径（只记这个也行）
```powershell
pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/setup.ps1
npm ci
npm run ci:all
code reports/ci-dashboard.md
```

遇到失败看哪里：
- 硬编码：`reports/hardcode-scan.txt`（pre-commit会打印Top行）
- 冒烟门禁：终端打印 Top失败域（pre-push增强），详情见 `reports/smoke-analysis.json`
- 接口/契约：`reports/interface-diff.md`、`reports/contract-check.md`


